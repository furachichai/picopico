-- PERSON CLASSglobal oG,oSoundproperty const,pState,pStateAnim,pDestX,pDestY,pFutDestX,pFutDestY,pX,pY,pIsoX,pIsoZ,pDir,pS,pStateGoto,pWait,pParts,pDepthNotYet,pFrameStart,pGoToMourn,pFrameStop,pAnimInfo,pMournFacing,pChangeDest,pPrevMedia,pUndoEvil,pKludge,pKludge2on new me,thenum,animinfo,themedia,prevmedia,themode    const=[#BSTOP:0,#BGOTO:1,#BAVOIDHORIZ:2,#BAVOIDVERT:3,#BMOURN:4,#BDEAD:5,#BTURN:6,GNORTH:0,GSOUTH:1,GWEST:2,GEAST:3,GCRYNORTH:4,GCRYSOUTH:5,GCRYWEST:6,GCRYEAST:7,GTURNNORTH:8,GTURNSOUTH:9,GTURNWEST:10,GTURNEAST:11,GDEAD:12]    me.pAnimInfo=animinfo    me.pState=me.const.BSTOP  me.pWait=0  me.pParts=6  me.pDepthNotYet=false  me.pGoToMourn=false  me.pChangeDest=false  me.pUndoEvil=false  me.pPrevMedia=prevmedia  me.pKludge=false  me.pKludge2=false    me.pX=random(oG.MAPWIDTH)-1  me.pY=random(oG.MAPHEIGHT)-1    if themode=oG.ONOFFSCREEN then            -- THIS COULD BE IMPROVED KNOWING WHICH TILES AREN'T ON THE MAP AND CHOSING ONE AT RANDOM    repeat while (not TileOnMap(me.pX,me.pY)) or PosNotEmpty(me.pX,me.pY)      me.pX=random(oG.MAPWIDTH)-1      me.pY=random(oG.MAPHEIGHT)-1        end repeat      else if themode=oG.ONSCREEN then        -- THIS COULD BE IMPROVED KNOWING WHICH TILES ARE ON SCREEN AND CHOSING ONE AT RANDOM        repeat while (not TileOnScreen(me.pX,me.pY)) or PosNotEmpty(me.pX,me.pY)      me.pX=random(oG.MAPWIDTH)-1      me.pY=random(oG.MAPHEIGHT)-1        end repeat      else if themode=oG.OFFSCREEN then        repeat while (not TileOnMap(me.pX,me.pY)) or TileOnScreen(me.pX,me.pY) or PosNotEmpty(me.pX,me.pY)      me.pX=random(oG.MAPWIDTH)-1      me.pY=random(oG.MAPHEIGHT)-1        end repeat      end if      me.pIsoX=me.pX*oG.ISOTILEWIDTH  me.pIsoZ=me.pY*oG.ISOTILEHEIGHT*-1    me.pFrameStart=1  me.pFrameStop=8    me.pS=sprite(thenum)    me.pS.member=themedia    me.pS.puppet = true    me.pS.ink = 36    me.pS.blend = 100    me.pS.rotation = 0                   PutFilmLoopOnScreen(me.pS,me.pIsox,0,me.pIsoZ)    me.pS.visible=true  me.mSetDepth()     return meendon mGetX me  return me.pXendon mGetY me  return me.pYendon mGoTo me,destx,desty  me.pState=me.const.BGOTO  me.pDestX=destx  me.pDestY=desty  me.pWait=me.pParts  me.mProcessGrid()  endon mGoToMourn me,destx,desty,facing  me.pGoToMourn=true  me.pChangeDest=true  me.pFutDestX=destx  me.pFutDestY=desty  me.pMournFacing=facingendon mUndoEvil me  me.pUndoEvil=true    me.pChangeDest=true  me.pFutDestX=me.pX  me.pFutDestY=me.pY  endon mMoveHoriz me  if me.pX>me.pDestX then    if PosNotEmpty(me.pX-1,me.pY) then      return false          else      me.pX=me.pX-1      me.pStateGoto=me.const.GWEST      me.mSetAnim(me.const.GWEST)      return true    end if  end if    if me.pX<me.pDestX then    if PosNotEmpty(me.pX+1,me.pY) then      return false          else      me.pX=me.pX+1      me.pStateGoto=me.const.GEAST            me.mSetAnim(me.const.GEAST)      return true    end if      end if  endon mMoveVert me  if me.pY>me.pDestY then    if PosNotEmpty(me.pX,me.pY-1) then      return false          else      me.pY=me.pY-1      me.pStateGoto=me.const.GNORTH      me.mSetAnim(me.const.GNORTH)      return true    end if  end if    if me.pY<me.pDestY then    if PosNotEmpty(me.pX,me.pY+1) then      return false          else      me.pY=me.pY+1      me.pStateGoto=me.const.GSOUTH            me.mSetAnim(me.const.GSOUTH)            return true    end if  end if    endon mAvoidHoriz me  if not me.mMoveVert() then    me.pX=me.pX+me.pDir    if me.pDir=1 then      me.pStateGoto=me.const.GEAST                  me.mSetAnim(me.const.GEAST)    else      me.pStateGoto=me.const.GWEST            me.mSetAnim(me.const.GWEST)    end if      else    me.pState=me.const.BGOTO      end if  endon mAvoidVert me  if not me.mMoveHoriz() then    me.pY=me.pY+me.pDir    if me.pDir=1 then      me.pStateGoto=me.const.GSOUTH                  me.mSetAnim(me.const.GSOUTH)    else      me.pStateGoto=me.const.GNORTH      me.mSetAnim(me.const.GNORTH)    end if          else    me.pState=me.const.BGOTO      end if    endon mProcessGrid me     case me.pState of    0:      -- me.BSTOP      tempx=random(oG.MAPWIDTH)-1      tempy=random(oG.MAPHEIGHT)-1      repeat while (not TileOnMap(tempx,tempy)) or PosNotEmpty(tempx,tempy)              tempx=random(oG.MAPWIDTH)-1                tempy=random(oG.MAPHEIGHT)-1              end repeat            me.mGoTo(tempx,tempy)          1:      -- me.BGOTO      me.mChangeTile()                  2:      me.mAvoidHoriz()    3:      me.mAvoidVert()        end case  endon mChangeTile me  if me.pChangeDest then    me.pChangeDest=false    me.pDestX=me.pFutDestX    me.pDestY=me.pFutDestY    if not me.pUndoEvil then      me.pParts=me.pParts/2       end if      end if    -- me.BGOTO  if me.pX=me.pDestX and me.pY=me.pDestY then    if me.pGoToMourn then      me.pState=me.const.BMOURN      me.pParts=me.pParts*2            oSound.mPlayCry()      me.mSetAnim(me.const.GCRYNORTH+me.pMournFacing)      me.pWait=oG.WAITMOURN*oG.FPS    else if me.pUndoEvil then      me.pState=me.const.BTURN      me.pKludge=true    else          me.pState=me.const.BSTOP      me.mProcessGrid()    end if      else    if me.pX=me.pDestX then      if not me.mMoveVert() then        me.pState=me.const.BAVOIDHORIZ        if random(2)=1 then                                pDir=1        else          pDir=-1                        end if                      me.mAvoidHoriz()                    end if     else if me.pY=me.pDestY then      if not me.mMoveHoriz() then        me.pState=me.const.BAVOIDVERT                      if me.pY<me.pDestY then          pDir=1        else          pDir=-1                        end if                                    me.mAvoidVert()                          end if                  else       if random(2)=1 then                if not me.mMoveVert() then          me.pState=me.const.BAVOIDHORIZ                        if me.pX<me.pDestX then            pDir=1          else            pDir=-1                          end if                                                    me.mAvoidHoriz()                      end if              else        if not me.mMoveHoriz() then          me.pState=me.const.BAVOIDVERT                        if random(2)=1 then                                  pDir=1          else            pDir=-1                          end if                                      me.mAvoidVert()                            end if                          end if                          end if  end if      endon mMove me  if (not me.pDepthNotYet) and (me.pWait<=me.pParts/2) then        me.pDepthNotYet=true    me.mSetDepth()          end if      if me.pWait-1=0 then    me.pIsoX=me.pX*oG.ISOTILEWIDTH    me.pIsoZ=me.pY*oG.ISOTILEHEIGHT*-1            me.pDepthNotYet=false  else          case me.pStateGoto of      0:        me.pIsoZ=me.pIsoZ+(oG.ISOTILEHEIGHT/me.pParts)      1:        me.pIsoZ=me.pIsoZ-(oG.ISOTILEHEIGHT/me.pParts)      2:        me.pIsoX=me.pIsoX-(oG.ISOTILEWIDTH/me.pParts)      3:              me.pIsoX=me.pIsoX+(oG.ISOTILEWIDTH/me.pParts)    end case        end if    PutFilmLoopOnScreen(me.pS,me.pIsox,0,me.pIsoZ)    me.pWait=me.pWait-1endon mSetDepth me    me.pS.locZ=oG.PERSON1STSPRITE+GetTileDepth(me.pX,me.pY)endon mSetAnim me,dir  if me.pStateAnim<>dir then    me.pStateAnim=dir    if me.pStateAnim<me.const.GCRYNORTH then      me.pFrameStart=(me.pStateAnim*8)+1      me.pFrameStop=me.pFrameStart+7      tell me.pS        go me.pFrameStart+random(8)-1      end tell                    else if me.pStateAnim<me.const.GTURNNORTH then      me.pFrameStart=me.pAnimInfo.crystart+((me.pStateAnim-me.const.GCRYNORTH)*me.pAnimInfo.crylength)      me.pFrameStop=me.pFrameStart+me.pAnimInfo.crylength-1      tell me.pS        go me.pFrameStart      end tell              else if me.pStateAnim<me.const.GDEAD then            me.pFrameStart=me.pAnimInfo.turnstart+((me.pStateAnim-me.const.GTURNNORTH)*me.pAnimInfo.turnlength)      me.pFrameStop=me.pFrameStart+me.pAnimInfo.turnlength-1            tell me.pS        go me.pFrameStart      end tell              else if me.pStateAnim=me.const.GDEAD then      me.pFrameStart=random(4)-1+me.pAnimInfo.deathstart            me.pFrameStop=me.pFrameStart            -- SET ANIM WON'T WORK HERE, BECAUSE IT CAN'T FIND THE pFrameStart PROPERTY IN THIS LINE: go me.pFrameStart.I CAN'T FIGURE OUT WHY.      kludge=me.pFrameStart      tell me.pS        go kludge      end tell         return 1    end if  end if    endon mCantMourn me  if me.pState=me.const.BDEAD or me.pGoToMourn or me.pState=me.const.BMOURN or me.pState=me.const.BTURN or me.pUndoEvil then    return true  else    return false  end if endon mDie me,tilex,tiley  me.pX=tilex  me.pY=tiley  me.pState=me.const.BDEAD  me.pWait=(oG.WAITDEAD*oG.FPS)+random(oG.WAITRANDOMDEAD*oG.FPS)-1  me.pIsoX=me.pX*oG.ISOTILEWIDTH  me.pIsoZ=me.pY*oG.ISOTILEHEIGHT*-1  me.mSetAnim(me.const.GDEAD)  --  me.mSetDepth()    me.pS.locZ=oG.PERSON1STSPRITE-1  PutDeadOnScreen(me.pS,me.pIsox,0,me.pIsoZ)endon mIsAlive me  if me.pState=me.const.BDEAD then    return false  else    return true  end if endon mDestroy me  me.pS.puppet = false  me.pS.member= VOID  me.pS.scriptInstanceList = []endon exitFrame me  if me.pState=me.const.BDEAD then    if pWait=0 then      DestroyPerson(me.pS)    else      pWait=pWait-1    end if  else if me.pState=me.const.BMOURN then        if pWait=0 then      oSound.mStopCry()            me.pGoToMourn=false            me.pState=me.const.BTURN      me.mSetAnim(me.pStateAnim+4)      oSound.mPlayPeople(oSound.STURN)    else      pWait=pWait-1    end if  else if me.pState<>me.const.BTURN then    if me.pState<>me.const.BSTOP then      me.mMove()    end if    if me.pWait=0 then      me.pWait=me.pParts      me.mProcessGrid()    end if  end if    -- LOOP THE CHARACTER'S ANIMATION  if me.pKludge2 then    me.pKludge2=false    me.mSetAnim(me.pStateAnim+8)        oSound.mPlayPeople(oSound.STURN)      else if me.pKludge then        me.pKludge=false    me.pKludge2=true    tell me.pS      if the frame=me.pFrameStop then        go me.pFrameStart-1      end if          end tell                UndoEvil(me.pS)                  else        if me.pState<>me.const.BTURN then      tell me.pS        if the frame=me.pFrameStop then          go me.pFrameStart-1        end if            end tell        else        isdone=false      tell me.pS        if the frame=me.pFrameStop then          -- YOU CAN'T CHANGE THE FILMLOOP INSIDE HERE          isdone=true        end if            end tell          if isdone then        me.pState=me.const.BSTOP                      if me.pUndoEvil then                  me.pWait=0          me.pUndoEvil=false        else                  me.pAnimInfo=[#deathstart:33]          TurnEvil(me.pS)        end if            end if          end if  end if  end