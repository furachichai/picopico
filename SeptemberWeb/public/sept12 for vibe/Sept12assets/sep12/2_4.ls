-- MAP CLASSglobal oG,oIso,oBuildingproperty MAPMEDIANAME,pArray,pWidth,pHeight,pISOTILEWIDTH,pISOTILEHEIGHT,pTileOnMapWidth,pTileOnMapHeight,pSon new me    me.MAPMEDIANAME="Map"    member(me.MAPMEDIANAME).regPoint=point(oG.SCREENX,oG.SCREENY/2)  sprite(oG.SPRITEMAP).locH=oG.SCREENX/2  sprite(oG.SPRITEMAP).locV=oG.SCREENY/2    me.pS=sprite(oG.SPRITEMAP)  me.pWidth=oG.MAPWIDTH  me.pHeight=oG.MAPHEIGHT  me.pISOTILEWIDTH=oG.ISOTILEWIDTH  me.pISOTILEHEIGHT=oG.ISOTILEHEIGHT  me.pTileOnMapWidth=member("Square",oG.MEDIACASTNUMBER).width  me.pTileOnMapHeight=member("Square",oG.MEDIACASTNUMBER).height    me.mCreateEmptyArray()  return meendon mGetIndex me,thex,they  return (thex)+(they*me.pWidth)+1endon mCreateEmptyArray me  me.pArray=[]  thecount=-1  repeat with tiley=0 to me.pHeight-1    repeat with tilex=0 to me.pWidth-1      obj=[#thedepth:thecount,#building:VOID]      me.pArray[me.mGetIndex(tilex,tiley)]=obj    end repeat  end repeatendon mSetDepth me  thecount=0  array=[]  thestate=0    tiley=0  repeat while tiley<me.pHeight    tilex=0    case thestate of      0:        -- GOING RIGHT, LOOKING FOR A WALL                        repeat while tilex<me.pWidth                  if me.mGetTileDepth(tilex,tiley)=-1 then                      building=me.mGetTileBuilding(tilex,tiley)                  if building=VOID then              me.mSetTileDepth(thecount,tilex,tiley)              thecount=thecount+1                  tilex=tilex+1            else              if building.thetype.theheight=1 then                me.mSetTileDepth(thecount,tilex,tiley)                thecount=thecount+1                    tilex=tilex+1                              else                                thestate=1                obj=[#destx:tilex,#desty:tiley+building.thetype.theheight-1]                array.addAt(1,obj)                exit repeat              end if                          end if                            else            tilex=tilex+1                      end if                  end repeat        tiley=tiley+1        -- WARNING: IF THE WALL IS 1x1 THIS WILL FAIL      1:                  -- A WALL WAS HIT                repeat while tilex<array[1].destx          if tilex=array[1].destx-1 and tiley=array[1].desty then                        -- REACHED WALL DESTINATION                       me.mSetTileDepth(thecount,tilex,tiley)            thecount=thecount+1             obj=array[1]            tilex=obj.destx            building=me.mGetTileBuilding(tilex,tiley)                                    tiley=obj.desty-building.thetype.theheight+1            array.deleteAt(1)                                repeat with i=tilex to tilex+building.thetype.thewidth-1              repeat with j=tiley to tiley+building.thetype.theheight-1                me.mSetTileDepth(thecount,i,j)                          end repeat            end repeat              tilex=tilex+building.thetype.thewidth                                thecount=thecount+1            if array.count=0 then              thestate=0 -- IF THE ARRAY IS EMPTY WE HAVE TO LOOK FOR MORE WALLS              exit repeat            end if                      else                        if me.mGetTileDepth(tilex,tiley)=-1 then              building=me.mGetTileBuilding(tilex,tiley)                    if building=VOID then                              me.mSetTileDepth(thecount,tilex,tiley)                thecount=thecount+1                  else                if building.thetype.theheight=1 then                  me.mSetTileDepth(thecount,tilex,tiley)                  thecount=thecount+1                    else                                                  -- ANOTHER WALL WAS FOUND                  obj=[#destx:tilex,#desty:tiley+building.thetype.theheight-1]                  array.addAt(1,obj)                                  exit repeat                                end if                              end if                          end if                        -- THIS TILE HAS BEEN PROCESSED BEFORE, SO WE GO TO THE NEXT            tilex=tilex+1          end if                        end repeat        if thestate=1 then          tiley=tiley+1 -- HAVEN'T FOUND THE DEST YET, GO TO NEXT ROW        end if            end case                    end repeat  endon mDraw me  --  repeat with tiley=0 to me.pHeight-1      --    repeat with tilex=0 to me.pWidth-1    --      if TileOnMap(tilex,tiley) then      --        obj=oIso.mMapToScreen(tilex*oG.ISOTILEWIDTH,0,-tiley*oG.ISOTILEHEIGHT)--        theleft=obj.thex+(sprite(oG.SPRITEMAP).locH)--        thetop=obj.they     --        if me.mGetTileBuilding(tilex,tiley)=VOID then        --          member(me.MAPMEDIANAME,oG.MEDIACASTNUMBER).image.copyPixels(member("Square",oG.MEDIACASTNUMBER).image,rect(theleft,thetop,theleft+member("Square",oG.MEDIACASTNUMBER).width,thetop+member("Square",oG.MEDIACASTNUMBER).height),member("Square",oG.MEDIACASTNUMBER).image.rect,[#ink:#backgroundTransparent,#useFastQuads:true])          --        end if              --      end if      --    end repeat--  end repeat     repeat with i=1 to oBuilding.pActualBuildingArray.count    sprite(oG.BUILDING1STSPRITE+i-1).locZ=oG.PERSON1STSPRITE+GetTileDepth(oBuilding.pActualBuildingArray[i].thex,oBuilding.pActualBuildingArray[i].they)  end repeat    oBuilding.mSortActualBuildingArray()    endon mSetTileBuilding me,obj,thex,they  me.pArray[(thex)+(they*me.pWidth)+1].building=objendon mGetTileBuilding me,thex,they  return me.pArray[(thex)+(they*me.pWidth)+1].buildingendon mSetTileDepth me,val,thex,they  me.pArray[(thex)+(they*me.pWidth)+1].thedepth=val  endon mGetTileDepth me,thex,they  return me.pArray[(thex)+(they*me.pWidth)+1].thedepth  end