global waitstreaming -- THIS VARIABLE IS USED TO DISTINGUISH IF THE GAME IS BEING RUN ONLINE ON NOT.global oG,oMap,oPeople,oIso,oBuilding,oSoundon CreateGlobalVar  -- SCREEN WIDTH    -- SCREENHEIGHT    -- FPS  -- MAP WIDTH    -- MAP HEIGHT    -- TILE WIDTH   -- TILE HEIGHT    -- START SPRITE FOR PEOPLE    -- MAX AMOUNT OF PEOPLE ONSTAGE    -- HOW MANY PEOPLE IS ONSTAGE AT START  -- RATE (IN SECONDS) TO GENERATE PEOPLE  return [#SCREENX:640,\  #SCREENY:480, \  #FPS:16, \  #MAPWIDTH:120,\  #MAPHEIGHT:120,\  #MAPSIZEX:1280, \  #MAPSIZEY:640, \  #TILEWIDTH:20,\  #TILEHEIGHT:10,\  #ISOTILEWIDTH: 14,\  #ISOTILEHEIGHT:14,\  #MAXPEOPLE:100, \  #STARTPEOPLE:100, \  #EVILMIN: 10, \  #EVILPERDEATH:4, \  #EVILREGENERATION:40, \  #GENERATIONRATIO:1, \  #RANDGENERATIONRATIO:1, \  #BLASTX:5, \  #BLASTY:5, \  #BLASTDAMAGE:5, \  #BLASTDECREMENT:1, \  #ISOSTARTX:(640/2)-(14/2), \  #ISOSTARTY:-325, \  #SCROLLHORIZ:100, \  #SCROLLSTEP:10, \  #SPRITEMAP:1, \  #SPRITELOADING:2, \  #SPRITEMENU:3, \  #SPRITETARGET:4, \  #SPRITEMISSILE:7, \  #BUILDING1STSPRITE:8, \  #PERSON1STSPRITE:200, \  #TARGETDEPTH:50000, \  #PEOPLEANIMLENGTH:8-1, \  #ONSCREEN:0, \  #OFFSCREEN:1, \  #ONOFFSCREEN:2, \  #MOURNDISTANCE:25, \  #DISTANCEFROMDEAD:2, \  #WAITDEAD:30, \  #WAITRANDOMDEAD:2, \  #WAITMOURN: 3, \  #WAITUNDOEVIL: 90, \  #UNDOEVILPEOPLE: 3, \  #BUILDINGHEALTHRECOVERY:10, \  #BUILDINGHEALTHRECOVERYTIME:30, \  #MEDIACASTNUMBER:3, \  #pUndoEvilWait:0, \  #pUndoEvilCount:0]endon BeginGame  put "----------------------"    put "----------------------"  put "-------NEW GAME-------"  put "----------------------"  put "----------------------"    -- oG is used to store global variables.  oG=CreateGlobalVar()  -- oIso handles the isometric view.   oIso=script("Isometric Class Parent").new()    -- oMap contains the map's 2D array.  oMap=script("Map Class Parent").new()  -- oBuilding handles all the buildings.  oBuilding=script("Building Class Parent").new()    oBuilding.mLoad()  oMap.mDraw()    -- oPeople handles the townsfolk.  oPeople=script("People Class Parent").new()  oPeople.mPopulate()      oSound=script("Sound Class Parent").new()  oSound.mPlay(oSound.SAMBIENT)    MissileInit()  TargetInit()      UndoEvilInit()endon PlayGame  oPeople.mGenerate()  oBuilding.mUpdate()  UndoEvilUpdate()    ScrollScreen()  endon UndoEvilInit  oG.pUndoEvilCount=0        UndoEvilWaitReset()endon UndoEvilWaitReset  if oG.pUndoEvilCount=0 then    oG.pUndoEvilWait=oG.WAITUNDOEVIL*oG.FPS    else    oG.pUndoEvilWait=(oG.WAITUNDOEVIL*oG.FPS)/2        end ifendon UndoEvilUpdate  if oG.pUndoEvilWait=0 then    oG.pUndoEvilCount=oG.pUndoEvilCount+1        UndoEvilWaitReset()    oPeople.mUndoEvil(oG.pUndoEvilCount*oG.UNDOEVILPEOPLE)  else    oG.pUndoEvilWait=oG.pUndoEvilWait-1  end if  endon UndoEvil thesprite  oPeople.pEvilCount=oPeople.pEvilCount-1  thesprite.member=thesprite.pPrevMedia  thesprite.pAnimInfo=oPeople.mCreateFrames2(thesprite.pPrevMedia)endon PosNotEmpty thex,they  if oMap.mGetTileBuilding(thex,they)=VOID then    return false  else    return true  end ifendon PosEmpty thex,they  if oMap.mGetTileBuilding(thex,they)=VOID then    return true      else    return false  end ifendon GetTileDepth thex,they  return oMap.mGetTileDepth(thex,they)endon MissileInit    member("Missile").pausedAtStart=TRUE  member("Missile").regPoint=point(121,249)endon TargetInit    member("Target").pausedAtStart=TRUE  endon ScrollScreen    thex=sprite(oG.SPRITETARGET).locH    if thex<oG.SCROLLHORIZ and sprite(oG.SPRITEMAP).left<0 then    diff=sprite(oG.SPRITEMAP).left+oG.SCROLLSTEP    if diff>0 then      MoveEverythingHoriz(oG.SCROLLSTEP-diff)    else      MoveEverythingHoriz(oG.SCROLLSTEP)          end if      else if thex>(oG.SCREENX-oG.SCROLLHORIZ) and sprite(oG.SPRITEMAP).right>oG.SCREENX then        diff=sprite(oG.SPRITEMAP).right-oG.SCROLLSTEP-oG.SCREENX        if diff<0 then      MoveEverythingHoriz(-oG.SCROLLSTEP-diff)          else            MoveEverythingHoriz(-oG.SCROLLSTEP)        end if          end if     endon MoveEverythingHoriz val  -- MOVE BACKGROUND  sprite(oG.SPRITEMAP).locH=sprite(oG.SPRITEMAP).locH+val    -- MOVE BUILDINGS  repeat with i=1 to oBuilding.pActualBuildingArray.count    thesprite=oBuilding.pActualBuildingArray[i].thesprite    thesprite.locH=thesprite.locH+val  end repeat       -- MOVE PEOPLE  repeat with i=1 to oPeople.pUsedSpriteArray.count    thesprite=oPeople.pUsedSpriteArray[i]    thesprite.locH=thesprite.locH+val      end repeat      -- MOVE MISSILE  if sprite(oG.SPRITEMISSILE).mWasLaunched() then    thesprite=sprite(oG.SPRITEMISSILE)        thesprite.locH=thesprite.locH+val      end if    -- MOVE ISOMETRIC VIEW STARTING POINT  oG.ISOSTARTX=oG.ISOSTARTX+valendon Floor(val)  intX=bitOr(val,0)  if(val=intX) then    return intX  else if(val>0) then    return intX  else    return intX-1  end ifendon TileOnScreen tilex,tiley    obj=oIso.mMapToScreen(tilex*oG.ISOTILEWIDTH,0,tiley*oG.ISOTILEHEIGHT*-1)  --  return (obj.thex<-20 or obj.thex>=oG.SCREENX or obj.they<-10 or obj.they>=oG.SCREENY)  if obj.thex<-20 or obj.thex>=oG.SCREENX or obj.they<-10 or obj.they>=oG.SCREENY then    return false  else    return true  end if    endon TileOnMap tilex,tiley    obj=oIso.mMapToScreen(tilex*oG.ISOTILEWIDTH,0,tiley*oG.ISOTILEHEIGHT*-1)  --  return (obj.thex>sprite(oG.SPRITEMAP).left and obj.thex<sprite(oG.SPRITEMAP).right and obj.they>sprite(oG.SPRITEMAP).top and obj.they<sprite(oG.SPRITEMAP).bottom)   if obj.thex>sprite(oG.SPRITEMAP).left and obj.thex<sprite(oG.SPRITEMAP).right and obj.they>sprite(oG.SPRITEMAP).top and obj.they<sprite(oG.SPRITEMAP).bottom then    return true  else    return false  end if  end-- RETURNS A RANDOM TILE INSIDE THE MAP AREAon RandTileOnMap  randx=random(oG.MAPSIZEX)+sprite(oG.SPRITEMAP).left-1  randy=random(oG.MAPSIZEY)-1  obj=GetTileFromMap(randx,randy)  return obj    end-- RETURNS A RANDOM TILE INSIDE THE SCREENon RandTileOnScreen  randx=random(oG.SCREENX)-1  randy=random(oG.SCREENY)-1    obj=GetTileFromMap(randx,randy)    return obj  endon PutSpriteOnScreen thesprite,thex,they,thez  obj=oIso.mMapToScreen(thex,they,thez)  thesprite.locH=obj.thex  thesprite.locV=obj.theyendon PutFilmLoopOnScreen thesprite,thex,they,thez  obj=oIso.mMapToScreen(thex,they,thez)  thesprite.locH=obj.thex+(oG.TILEWIDTH/2)+1  thesprite.locV=obj.they-(thesprite.height/2)+oG.TILEHEIGHT  endon PutDeadOnScreen thesprite,thex,they,thez  obj=oIso.mMapToScreen(thex,they,thez)  thesprite.locH=obj.thex+(oG.TILEWIDTH/2)+1  thesprite.locV=obj.they+(oG.TILEHEIGHT/2)  endon GetTileFromMap screenx,screeny  obj=oIso.mMapToIsoWorld(screenx,screeny)  return [#tilex:Floor(obj.thex/oG.ISOTILEWIDTH),#tiley:Floor(obj.thez/oG.ISOTILEHEIGHT)*-1]endon TurnEvil thesprite  oPeople.pEvilCount=oPeople.pEvilCount+1  thesprite.member=oPeople.pMediaArray[oPeople.TEVIL]  endon DestroyPerson thesprite  repeat with i=1 to oPeople.pUsedSpriteArray.count    if oPeople.pUsedSpriteArray[i]=thesprite then      oPeople.pEmptySpriteArray.append(thesprite)            oPeople.pUsedSpriteArray.deleteAt(i)                  if thesprite.member=oPeople.pMediaArray[oPeople.TEVIL] then        oPeople.pEvilCount=oPeople.pEvilCount-1                if oPeople.pEvilCount>oG.EVILMIN then          if random(100)<=oG.EVILREGENERATION then            oPeople.pEvilToRegenerate=oPeople.pEvilToRegenerate+1                    end if                  end if        end if            thesprite.mDestroy()      exit repeat    end if      end repeat  endon mouseUp  if the frame=Marker("MPlay") then   -- THE EXPLOTION SHOULD OCCUR ONLY IN THE FRAME "PLAY"    if sprite(oG.SPRITETARGET).mIsEnabled() then                  oSound.mPlay(oSound.SCLICK)      sprite(oG.SPRITETARGET).mDisable()            UndoEvilInit()      thex=sprite(oG.SPRITETARGET).locH      they=sprite(oG.SPRITETARGET).locV      -- THIS IF MIGHT BE UNNECESSARY. CHECK DOCUMENTATION      if thex>=0 and thex<oG.SCREENX and they>=0 and they<oG.SCREENY then        obj=oBuilding.mHit(thex,they)        if obj.hitted then          thebottom=obj.thebottom                    -- IF THE MISSILE FALLS ON A BUILDING, ITS CENTER BECAMES THE CENTER OF THE EXPLOTION          tilex=obj.building.thex-obj.building.thetype.thewidth/2          tiley=obj.building.they-obj.building.thetype.theheight/2        else                thebottom=true                    obj=GetTileFromMap(thex,they)                tilex=obj.tilex          tiley=obj.tiley        end if        thedepth=oG.PERSON1STSPRITE+GetTileDepth(tilex+oG.BLASTX,tiley+oG.BLASTY)+1  -- WARNING: THIS ADDITION COULD RETURN A TILE OUTSIDE THE MAP        sprite(oG.SPRITEMISSILE).mLaunch(thebottom,tilex,tiley,thex,they,thedepth)              end if    end if      end if  endon mouseDown  -- KLUDGE TO SOLVE THE HIDING CURSOR BUG.  if the frame=Marker("MPlay") then      cursor 0    cursor 200  end if  endon Explotion groundlevel,tilex,tiley  if groundlevel then    oBuilding.mExplode(tilex,tiley)    oPeople.mKill(tilex,tiley)  else    oBuilding.mExplodeTall(tilex,tiley)      end if  endon GetBlastDamage thex,they  return sprite(oG.SPRITEMISSILE).mGetDamage(thex,they)endon prepareMovie  waitstreaming=false   tellStreamStatus(true)endon streamStatus URL, state, bytesSoFar, bytesTotal, error  waitstreaming=true  --  integer(float(bytesSoFar)/float(bytesTotal)*100.0)    setVariable(sprite(499),"tempbytesloaded",string(bytesSoFar))  setVariable(sprite(499),"tempbytestotal",string(bytesTotal))    if state = "Complete" then    tellStreamStatus(false)        go Marker("MInit")  end ifend